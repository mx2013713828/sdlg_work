# <div align='center'> ⭐20240706周工作日志⭐ </div>
  
<div align = "center"> <img src="https://pic.imgdb.cn/item/65dc5dfc9f345e8d03446103.png" height=100 width=300> </div>

#### <p align = "center">![Static Badge](https://img.shields.io/badge/mayufeng-blue?style=flat&label=Author)![Static Badge](https://img.shields.io/badge/2024/07/06-blue?style=flat&label=CreateTime)![Static Badge](https://img.shields.io/badge/97357473@qq\.com\-blue?style=flat&label=Email)</p>

---

- [Nvidia-Cuda-Centerpoint](#使用nvidia代码库提供的centerpoint模型和参数跑通代码)
- [转化openpcdet(once)](#转化openpcdetonce版本centerpoint模型)
- [训练CenterPoint模型](#自己训练openpcdet版本centerpoint模型)
- [训练640尺寸PointPillars](#自己训练pointpillars的640尺寸模型)


## 使用NVIDIA代码库提供的CenterPoint模型和参数跑通代码

1. 下载模型和参数
2. 代码调试
    - 报错编译报错,spconv库依赖libprotoc库特定版本,已解决
    - 模型参数加载报错,模型参数加载失败,模型定义时模型名字与提供模型定义名不一致，已解决
3. 运行成功,官方代码和模型已调试成功.

## 转化openpcdet(once)版本CenterPoint模型

1. 下载openpcdet(once)版本CenterPoint模型

2. 转化3D卷积层 export scn

    1. 问题1:模型层名字和官方版本不一致，如何转化？
        - 将openpcdet版本pth中的模型名字修改为和官方版本一致
        - 将openpcdet版本pth模型中的参数值复制到官方版本pth模型中
    2. 问题2:模型头部，nuscences是6个头，自制数据集头数不一致如何操作？

    3. 转换官方模型成功。

3. 转化瓶颈层和检测头 export head

    1. 转换官方模型成功
    2. 问题3:官方模型使用nuscense，点云为N * 5,(x, y, z, intensity, ring index)
        - 自制数据集只有x,y,z三维,可能需要额外添加一个维度,或者模型转化时强制使用4个维度.
        - 必须：模型和输入输入维度匹配，输入维度和VFE函数参数匹配。注意！！！
    3. 问题4:neck.deblocks.0.0.weight 尺寸不匹配
        - Openpcdet 版本为torch.Size([128, 256, 1, 1])
        - 官方版本为torch.Size([256, 128, 1, 1])
        - 已解决。


## 自己训练OpenPCDet版本CenterPoint模型

1. 使用Openpcdet提供的参数训练模型

    1. 问题5:参数中未使用vel,导致检测头与原版centerpoint不一致。
    在训练时，添加两列属性：vel_x vel_y，使用0占位，调整训练时损失函数的权重，将其设为0.01，尽可能不影响损失函数收敛。

    2. 问题6:模型网络结果与centerpoint官方不一致。
    Openpcdet中的base_bev_backbone.py BaseBEVBackbone结构有错误，导致产生两个上采样层(转置卷积)（Centerpoint中是一个下采样层，另一个下采样使用卷积层代替）,已解决，通过修复代码bug解决。(本来想提交PR，但是查看Openpcdet最新代码，此处代码bug也已经修复)。

    3. 训练结果
    模型训练20个epoch，验证集结果如下：
    相对pointpillars有整体提升。
```vim
Car AP_R40@0.70, 0.50, 0.50:
bbox AP:94.7387, 94.7387, 94.7387
bev  AP:92.7781, 92.7781, 92.7781
3d   AP:90.5744, 90.5744, 90.5744
aos  AP:91.82, 91.82, 91.82
Pedestrian AP_R40@0.50, 0.25, 0.25:
bbox AP:44.1036, 44.1036, 44.1036
bev  AP:28.2476, 28.2476, 28.2476
3d   AP:27.7247, 27.7247, 27.7247
aos  AP:30.53, 30.53, 30.53
Truck AP_R40@0.50, 0.25, 0.25:
bbox AP:68.6095, 68.6095, 68.6095
bev  AP:63.5310, 63.5310, 63.5310
3d   AP:63.5277, 63.5277, 63.5277
aos  AP:60.36, 60.36, 60.36
Van AP_R40@0.70, 0.50, 0.50:
bbox AP:33.6108, 33.6108, 33.6108
bev  AP:33.6047, 33.6047, 33.6047
3d   AP:33.6047, 33.6047, 33.6047
aos  AP:32.37, 32.37, 32.37
Cyclist AP_R40@0.50, 0.25, 0.25:
bbox AP:64.6667, 64.6667, 64.6667
bev  AP:62.0000, 62.0000, 62.0000
3d   AP:62.0000, 62.0000, 62.0000
aos  AP:63.37, 63.37, 63.37
Sedan AP_R40@0.50, 0.50, 0.50:
bbox AP:96.0540, 96.0540, 96.0540
bev  AP:81.2789, 81.2789, 81.2789
3d   AP:80.3210, 80.3210, 80.3210
aos  AP:57.83, 57.83, 57.83
Loader AP_R40@0.70, 0.50, 0.50:
bbox AP:12.5000, 12.5000, 12.5000
bev  AP:12.5000, 12.5000, 12.5000
3d   AP:12.5000, 12.5000, 12.5000
aos  AP:12.50, 12.50, 12.50
Mediumtruck AP_R40@0.70, 0.70, 0.70:
bbox AP:81.5918, 81.5918, 81.5918
bev  AP:64.2037, 64.2037, 64.2037
3d   AP:58.4505, 58.4505, 58.4505
aos  AP:64.92, 64.92, 64.92
```

## 自己训练PointPillars的640尺寸模型

- 训练100个轮，验证集结果如下：

相对432 * 496 版本有整体提升
```vim
Car AP_R40@0.70, 0.70, 0.70:
bbox AP:88.0440, 88.0440, 88.0440
bev  AP:83.2032, 83.2032, 83.2032
3d   AP:75.2351, 75.2351, 75.2351
aos  AP:87.51, 87.51, 87.51
Car AP_R40@0.70, 0.50, 0.50:
bbox AP:88.0440, 88.0440, 88.0440
bev  AP:86.9309, 86.9309, 86.9309
3d   AP:86.7264, 86.7264, 86.7264
aos  AP:87.51, 87.51, 87.51
Pedestrian AP_R40@0.50, 0.50, 0.50:
bbox AP:26.0739, 26.0739, 26.0739
bev  AP:20.3192, 20.3192, 20.3192
3d   AP:15.7773, 15.7773, 15.7773
aos  AP:19.42, 19.42, 19.42
Pedestrian AP_R40@0.50, 0.25, 0.25:
bbox AP:26.0739, 26.0739, 26.0739
bev  AP:22.7398, 22.7398, 22.7398
3d   AP:22.7299, 22.7299, 22.7299
aos  AP:19.42, 19.42, 19.42
Truck AP_R40@0.50, 0.50, 0.50:
bbox AP:77.2614, 77.2614, 77.2614
bev  AP:77.1236, 77.1236, 77.1236
3d   AP:77.0979, 77.0979, 77.0979
aos  AP:68.96, 68.96, 68.96
Truck AP_R40@0.50, 0.25, 0.25:
bbox AP:77.2614, 77.2614, 77.2614
bev  AP:77.1236, 77.1236, 77.1236
3d   AP:77.1236, 77.1236, 77.1236
aos  AP:68.96, 68.96, 68.96
Van AP_R40@0.70, 0.70, 0.70:
bbox AP:51.6120, 51.6120, 51.6120
bev  AP:51.2935, 51.2935, 51.2935
3d   AP:49.0351, 49.0351, 49.0351
aos  AP:47.18, 47.18, 47.18
Van AP_R40@0.70, 0.50, 0.50:
bbox AP:51.6120, 51.6120, 51.6120
bev  AP:51.6120, 51.6120, 51.6120
3d   AP:51.6120, 51.6120, 51.6120
aos  AP:47.18, 47.18, 47.18
Cyclist AP_R40@0.50, 0.50, 0.50:
bbox AP:76.9975, 76.9975, 76.9975
bev  AP:71.8422, 71.8422, 71.8422
3d   AP:71.8422, 71.8422, 71.8422
aos  AP:76.00, 76.00, 76.00
Cyclist AP_R40@0.50, 0.25, 0.25:
bbox AP:76.9975, 76.9975, 76.9975
bev  AP:71.8422, 71.8422, 71.8422
3d   AP:71.8422, 71.8422, 71.8422
aos  AP:76.00, 76.00, 76.00
Sedan AP_R40@0.70, 0.70, 0.70:
bbox AP:72.1377, 72.1377, 72.1377
bev  AP:63.6687, 63.6687, 63.6687
3d   AP:59.9682, 59.9682, 59.9682
aos  AP:43.16, 43.16, 43.16
Sedan AP_R40@0.50, 0.50, 0.50:
bbox AP:72.1377, 72.1377, 72.1377
bev  AP:66.3618, 66.3618, 66.3618
3d   AP:66.3104, 66.3104, 66.3104
aos  AP:43.16, 43.16, 43.16
Loader AP_R40@0.70, 0.70, 0.70:
bbox AP:10.0000, 10.0000, 10.0000
bev  AP:10.0000, 10.0000, 10.0000
3d   AP:10.0000, 10.0000, 10.0000
aos  AP:10.00, 10.00, 10.00
Loader AP_R40@0.70, 0.50, 0.50:
bbox AP:10.0000, 10.0000, 10.0000
bev  AP:10.0000, 10.0000, 10.0000
3d   AP:10.0000, 10.0000, 10.0000
aos  AP:10.00, 10.00, 10.00
Mediumtruck AP_R40@0.70, 0.70, 0.70:
bbox AP:53.3271, 53.3271, 53.3271
bev  AP:50.7722, 50.7722, 50.7722
3d   AP:49.9061, 49.9061, 49.9061
aos  AP:38.41, 38.41, 38.41
Mediumtruck AP_R40@0.70, 0.70, 0.70:
bbox AP:53.3271, 53.3271, 53.3271
bev  AP:50.7722, 50.7722, 50.7722
3d   AP:49.9061, 49.9061, 49.9061
aos  AP:38.41, 38.41, 38.41
```