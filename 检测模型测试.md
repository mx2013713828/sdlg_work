# 各个模型测试结果

## coco128测试

### 测试环境

- 环境 torch1.9.0 ,intel 9900k cpu,ubuntu20.04.

| 模型  | 速度(batch1) |精度mAP.5|
| :----:| :----:| :----:|
| yolov5 | 57.3| ### |
| yolov5-lite-e | 44.2 | 0.805 |
| yolov7-tiny | 56. | 0.753 |
- yolov7 测试代码
```python
python test.py --data data/coco128.yaml --img 640 --batch 1 --conf 0.001 --iou 0.65 --device cpu --weights yolov7-tiny.pt 
```

- yolov5-lite测试代码
```python
python test.py --data data/coco128.yaml --img 640 --batch 1 --conf 0.001 --iou 0.65 --device cpu --weights v5-lite-e.pt
```

- yolov5测试代码
```python
python val.py --data data/coco128.yaml --img 640 --batch 1 --conf 0.001 --iou 0.65 --device cpu --weights yolov5s.pt
```

# openvino安装与部署 


## openvino安装

使用pip安装
```bash
pip install openvino-dev[tensorflow2,pytorch,ONNX]==2022.1.0
```
版本可自行选择，但是openvino的高版本对低版本缺乏兼容性，项目与环境版本不同很容易报错。

## YOLOV5-lite openvino部署

### pt模型转化成
```bash
$ python models/export.py --weights v5lite-c.pt --img 640 --batch 1
$ python -m onnxsim v5lite-c.onnx v5lite-c-sim.onnx
```
###	转化 to IR model
```bash
mo --input_model v5lite-c.onnx -s 255 --data_type FP16  --reverse_input_channels --output Conv_462,Conv_478,Conv_494
```

###	Inference
有xml和bin文件后就可以进行推理了。
```bash
python openvino.py -m v5lite-c.xml -i bike.jpg
```

## openvino版本不同造成的问题
2021.3 和 2022.1版本不同，需要改动一些属性和方法。

```python
# out_blob_n, out_blob_c, out_blob_h, out_blob_w = blob.shape
out_blob_n, out_blob_c, out_blob_h, out_blob_w = blob._initial_shape
```
```python
predictions = 1.0 / (1.0 + np.exp(-blob.buffer))
```
```python
# net = IENetwork(model=model_xml, weights=model_bin)
net = ie.read_network(model=model_xml, weights=model_bin)
```
```python
# n, c, h, w = net.inputs[input_blob].shape
n, c, h, w = net.input_info[input_blob].input_data.shape
```
```python
# out_blob.shape = layer_params[0]
out_blob.set_shape(layer_params[0])
```
```python
# output = exec_net.requests[cur_request_id].outputs
output = exec_net.requests[cur_request_id].output_blobs
```

## v5-lite 测试结果(python版本)

| 模型  | 加速方法 |图片大小|推理速度 |
| :----:| :----:| :----:|:----:|
| v5-lite-e | openvino| 640 |5ms |
| v5-lite-c | openvino| 640 |20ms|
| v5-lite-c | openvino| 416 |8ms |
| v7-tiny-# | openvino| 640 |54  |
| v5-s      | openvino| 640 |28ms|